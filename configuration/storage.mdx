---
title: "Storage Configuration"
description: "Configure local filesystem or S3-compatible storage backends for ImageFlow"
---

## Storage Backends

ImageFlow supports two storage backends for maximum flexibility:

- **Local Storage**: Store images on the local filesystem
- **S3 Storage**: Use Amazon S3 or S3-compatible services

Choose the backend that best fits your deployment needs and scale requirements.

## Local Storage Configuration

Local storage is perfect for development, small deployments, or when you need complete control over your files.

### Basic Configuration

```env
# Storage type
STORAGE_TYPE=local

# Storage directory (relative or absolute path)
LOCAL_STORAGE_PATH=./static/images
```

### Directory Structure

ImageFlow organizes images in a structured directory layout:

```
static/images/
├── original/
│   ├── landscape/
│   │   └── image1.jpg
│   └── portrait/
│       └── image2.jpg
├── landscape/
│   ├── webp/
│   │   └── image1.webp
│   └── avif/
│       └── image1.avif
├── portrait/
│   ├── webp/
│   │   └── image2.webp
│   └── avif/
│       └── image2.avif
└── gif/
    └── animated.gif
```

### Setup Instructions

<Tabs>
  <Tab title="Linux/macOS">
    ```bash
    # Create storage directory
    mkdir -p ./static/images

    # Set proper permissions
    chmod 755 ./static/images

    # For production, use absolute paths
    sudo mkdir -p /var/lib/imageflow/images
    sudo chown -R imageflow:imageflow /var/lib/imageflow
    sudo chmod 755 /var/lib/imageflow/images
    ```

    **Production Configuration:**
    ```env
    STORAGE_TYPE=local
    LOCAL_STORAGE_PATH=/var/lib/imageflow/images
    ```
  </Tab>

  <Tab title="Windows">
    ```powershell
    # Create storage directory
    New-Item -ItemType Directory -Force -Path ".\static\images"

    # For production, use absolute paths
    New-Item -ItemType Directory -Force -Path "C:\ImageFlow\images"
    ```

    **Production Configuration:**
    ```env
    STORAGE_TYPE=local
    LOCAL_STORAGE_PATH=C:\ImageFlow\images
    ```
  </Tab>

  <Tab title="Docker">
    ```bash
    # Create volume for persistent storage
    docker volume create imageflow-storage

    # Run with volume mount
    docker run -d \
      -v imageflow-storage:/app/static/images \
      -e STORAGE_TYPE=local \
      -e LOCAL_STORAGE_PATH=/app/static/images \
      imageflow:latest
    ```

    **Docker Compose:**
    ```yaml
    services:
      imageflow:
        image: imageflow:latest
        environment:
          - STORAGE_TYPE=local
          - LOCAL_STORAGE_PATH=/app/static/images
        volumes:
          - imageflow-storage:/app/static/images

    volumes:
      imageflow-storage:
    ```
  </Tab>
</Tabs>

### Local Storage Benefits

<CardGroup cols={2}>
  <Card title="Full Control" icon="shield">
    Complete control over file storage, permissions, and backup strategies
  </Card>
  
  <Card title="No External Dependencies" icon="server">
    No reliance on external services or internet connectivity
  </Card>
  
  <Card title="Cost Effective" icon="dollar-sign">
    No storage costs beyond your server's disk space
  </Card>
  
  <Card title="Low Latency" icon="zap">
    Fastest possible file access with local disk I/O
  </Card>
</CardGroup>

### Local Storage Limitations

- **Scalability**: Limited by single server storage capacity
- **Redundancy**: Requires manual backup and disaster recovery setup
- **CDN**: Manual CDN configuration for global distribution

## S3 Storage Configuration

S3 storage provides scalable, distributed storage with built-in redundancy and global distribution capabilities.

### Basic Configuration

```env
# Storage type
STORAGE_TYPE=s3

# S3 endpoint and region
S3_ENDPOINT=s3.amazonaws.com
S3_REGION=us-east-1

# S3 bucket
S3_BUCKET=your-imageflow-bucket

# S3 credentials
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key

# Optional custom domain
CUSTOM_DOMAIN=cdn.yourdomain.com
```

### Supported S3 Services

<Tabs>
  <Tab title="Amazon S3">
    ```env
    S3_ENDPOINT=s3.amazonaws.com
    S3_REGION=us-east-1
    S3_BUCKET=your-bucket-name
    S3_ACCESS_KEY=AKIA...
    S3_SECRET_KEY=your-secret-key
    ```

    **Setup Steps:**
    1. Create an S3 bucket in AWS Console
    2. Create IAM user with S3 permissions
    3. Generate access keys
    4. Configure bucket policy for public read access
  </Tab>

  <Tab title="DigitalOcean Spaces">
    ```env
    S3_ENDPOINT=nyc3.digitaloceanspaces.com
    S3_REGION=nyc3
    S3_BUCKET=your-space-name
    S3_ACCESS_KEY=your-spaces-key
    S3_SECRET_KEY=your-spaces-secret
    CUSTOM_DOMAIN=your-space-name.nyc3.cdn.digitaloceanspaces.com
    ```
  </Tab>

  <Tab title="Wasabi">
    ```env
    S3_ENDPOINT=s3.wasabisys.com
    S3_REGION=us-east-1
    S3_BUCKET=your-wasabi-bucket
    S3_ACCESS_KEY=your-wasabi-key
    S3_SECRET_KEY=your-wasabi-secret
    ```
  </Tab>

  <Tab title="MinIO">
    ```env
    S3_ENDPOINT=your-minio-server.com:9000
    S3_REGION=us-east-1
    S3_BUCKET=imageflow
    S3_ACCESS_KEY=minio-access-key
    S3_SECRET_KEY=minio-secret-key
    ```

    **Self-hosted MinIO:**
    ```bash
    # Run MinIO server
    docker run -d \
      -p 9000:9000 \
      -p 9001:9001 \
      -e MINIO_ROOT_USER=admin \
      -e MINIO_ROOT_PASSWORD=password123 \
      minio/minio server /data --console-address ":9001"
    ```
  </Tab>
</Tabs>

### S3 Bucket Setup

<AccordionGroup>
  <Accordion title="Create S3 Bucket">
    **AWS CLI:**
    ```bash
    # Create bucket
    aws s3 mb s3://your-imageflow-bucket --region us-east-1

    # Enable versioning (optional)
    aws s3api put-bucket-versioning \
      --bucket your-imageflow-bucket \
      --versioning-configuration Status=Enabled
    ```

    **AWS Console:**
    1. Go to S3 service in AWS Console
    2. Click "Create bucket"
    3. Enter bucket name and select region
    4. Keep default settings or customize as needed
    5. Click "Create bucket"
  </Accordion>

  <Accordion title="Configure Bucket Policy">
    Allow public read access for image serving:

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Sid": "PublicReadGetObject",
          "Effect": "Allow",
          "Principal": "*",
          "Action": "s3:GetObject",
          "Resource": "arn:aws:s3:::your-imageflow-bucket/*"
        }
      ]
    }
    ```

    **Apply via AWS CLI:**
    ```bash
    aws s3api put-bucket-policy \
      --bucket your-imageflow-bucket \
      --policy file://bucket-policy.json
    ```
  </Accordion>

  <Accordion title="Create IAM User">
    Create dedicated user for ImageFlow:

    ```json
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "s3:GetObject",
            "s3:PutObject",
            "s3:DeleteObject",
            "s3:ListBucket"
          ],
          "Resource": [
            "arn:aws:s3:::your-imageflow-bucket",
            "arn:aws:s3:::your-imageflow-bucket/*"
          ]
        }
      ]
    }
    ```
  </Accordion>

  <Accordion title="Enable CORS">
    Allow cross-origin requests:

    ```json
    [
      {
        "AllowedHeaders": ["*"],
        "AllowedMethods": ["GET", "HEAD"],
        "AllowedOrigins": ["*"],
        "ExposeHeaders": ["ETag"],
        "MaxAgeSeconds": 3000
      }
    ]
    ```

    **Apply via AWS CLI:**
    ```bash
    aws s3api put-bucket-cors \
      --bucket your-imageflow-bucket \
      --cors-configuration file://cors.json
    ```
  </Accordion>
</AccordionGroup>

### CDN Configuration

Improve global performance with CloudFront or other CDNs:

<Tabs>
  <Tab title="Amazon CloudFront">
    ```env
    CUSTOM_DOMAIN=d123456789.cloudfront.net
    ```

    **Setup Steps:**
    1. Create CloudFront distribution
    2. Set origin to your S3 bucket
    3. Configure caching behaviors
    4. Update CUSTOM_DOMAIN in ImageFlow
  </Tab>

  <Tab title="Cloudflare">
    ```env
    CUSTOM_DOMAIN=images.yourdomain.com
    ```

    **Setup Steps:**
    1. Add CNAME record pointing to S3 bucket
    2. Enable Cloudflare proxy
    3. Configure caching rules
    4. Set up SSL/TLS
  </Tab>
</Tabs>

### S3 Storage Benefits

<CardGroup cols={2}>
  <Card title="Scalability" icon="expand">
    Unlimited storage capacity that scales automatically
  </Card>
  
  <Card title="Durability" icon="shield-check">
    99.999999999% (11 9's) durability with automatic redundancy
  </Card>
  
  <Card title="Global Distribution" icon="globe">
    Easy CDN integration for worldwide content delivery
  </Card>
  
  <Card title="Cost Efficiency" icon="calculator">
    Pay only for what you use with automatic lifecycle management
  </Card>
</CardGroup>

## Performance Optimization

### Local Storage Optimization

<AccordionGroup>
  <Accordion title="File System Choice">
    **Linux:**
    - **ext4**: Good general performance
    - **XFS**: Better for large files
    - **ZFS**: Advanced features with compression

    **macOS:**
    - **APFS**: Modern file system with optimizations

    **Windows:**
    - **NTFS**: Standard with good performance
  </Accordion>

  <Accordion title="SSD vs HDD">
    **SSD Recommended:**
    - Faster random access
    - Better concurrent performance
    - Lower latency for image serving

    **HDD Considerations:**
    - Higher capacity per dollar
    - Sequential performance adequate for large files
    - Consider for archival storage
  </Accordion>

  <Accordion title="Directory Structure">
    ```bash
    # Optimize for many files
    # Use subdirectories to avoid large directory listings
    static/images/
    ├── 2023/
    │   ├── 01/
    │   ├── 02/
    │   └── ...
    ├── 2024/
    │   ├── 01/
    │   └── ...
    ```
  </Accordion>
</AccordionGroup>

### S3 Performance Optimization

<AccordionGroup>
  <Accordion title="Request Patterns">
    - Use CloudFront for frequent access patterns
    - Enable S3 Transfer Acceleration for uploads
    - Use multipart uploads for large files
    - Implement intelligent tiering for cost optimization
  </Accordion>

  <Accordion title="Naming Conventions">
    ```
    # Good: Random prefix distribution
    abc123/image1.jpg
    def456/image2.jpg
    ghi789/image3.jpg

    # Avoid: Sequential prefixes (hotspotting)
    2023/01/01/image1.jpg
    2023/01/01/image2.jpg
    2023/01/01/image3.jpg
    ```
  </Accordion>
</AccordionGroup>

## Storage Migration

### Local to S3 Migration

```bash
# Sync local storage to S3
aws s3 sync ./static/images/ s3://your-imageflow-bucket/ \
  --recursive \
  --include "*" \
  --storage-class STANDARD

# Update configuration
sed -i 's/STORAGE_TYPE=local/STORAGE_TYPE=s3/' .env

# Restart ImageFlow
systemctl restart imageflow
```

### S3 to Local Migration

```bash
# Sync S3 to local storage
aws s3 sync s3://your-imageflow-bucket/ ./static/images/ \
  --recursive \
  --include "*"

# Update configuration
sed -i 's/STORAGE_TYPE=s3/STORAGE_TYPE=local/' .env

# Restart ImageFlow
systemctl restart imageflow
```

## Backup Strategies

<Tabs>
  <Tab title="Local Storage Backup">
    ```bash
    #!/bin/bash
    # Daily backup script

    BACKUP_DIR="/backup/imageflow-$(date +%Y%m%d)"
    SOURCE_DIR="/var/lib/imageflow/images"

    # Create backup directory
    mkdir -p "$BACKUP_DIR"

    # Sync files
    rsync -av "$SOURCE_DIR/" "$BACKUP_DIR/"

    # Compress backup
    tar -czf "$BACKUP_DIR.tar.gz" -C /backup "$(basename $BACKUP_DIR)"

    # Clean up old backups (keep 30 days)
    find /backup -name "imageflow-*.tar.gz" -mtime +30 -delete
    ```
  </Tab>

  <Tab title="S3 Backup">
    **Cross-Region Replication:**
    ```json
    {
      "Role": "arn:aws:iam::account:role/replication-role",
      "Rules": [
        {
          "Status": "Enabled",
          "Prefix": "",
          "Destination": {
            "Bucket": "arn:aws:s3:::backup-bucket",
            "StorageClass": "STANDARD_IA"
          }
        }
      ]
    }
    ```

    **Versioning and Lifecycle:**
    ```json
    {
      "Rules": [
        {
          "Status": "Enabled",
          "Transitions": [
            {
              "Days": 30,
              "StorageClass": "STANDARD_IA"
            },
            {
              "Days": 90,
              "StorageClass": "GLACIER"
            }
          ]
        }
      ]
    }
    ```
  </Tab>
</Tabs>

## Troubleshooting

<AccordionGroup>
  <Accordion title="Permission Denied (Local)">
    ```bash
    # Check permissions
    ls -la ./static/images

    # Fix permissions
    chmod 755 ./static/images
    chown -R $(whoami):$(whoami) ./static/images
    ```
  </Accordion>

  <Accordion title="S3 Access Denied">
    ```bash
    # Test S3 access
    aws s3 ls s3://your-imageflow-bucket

    # Check IAM permissions
    aws iam get-user-policy --user-name imageflow-user --policy-name ImageFlowPolicy

    # Test with ImageFlow credentials
    AWS_ACCESS_KEY_ID=your-key AWS_SECRET_ACCESS_KEY=your-secret aws s3 ls s3://your-imageflow-bucket
    ```
  </Accordion>

  <Accordion title="Slow Performance">
    **Local Storage:**
    - Check disk I/O: `iostat -x 1`
    - Monitor disk space: `df -h`
    - Check file system: `fsck`

    **S3 Storage:**
    - Enable CloudFront caching
    - Use appropriate S3 storage class
    - Check network connectivity
  </Accordion>
</AccordionGroup>

## Next Steps

<CardGroup cols={2}>
  <Card title="Redis Configuration" icon="memory" href="/configuration/redis">
    Set up Redis for improved metadata performance
  </Card>
  
  <Card title="Image Processing" icon="image" href="/configuration/image-processing">
    Configure image optimization settings
  </Card>
  
  <Card title="Production Deployment" icon="server" href="/deployment/production">
    Deploy ImageFlow to production
  </Card>
  
  <Card title="Monitoring" icon="chart-line" href="/deployment/monitoring">
    Monitor storage performance and usage
  </Card>
</CardGroup>